# Face Mask Editor

Face Mask Editorは、写真内の顔を自動的に検出し、絵文字で隠すことができるWebアプリケーションです。
ブラウザ上で動作し、自動検出されたマスクの位置やサイズ、角度を手動で微調整することも可能です。

## 機能

- **高精度な自動検出**: **OpenCV DNN (SSD)** を採用し、コラージュ写真や小さな顔でも安定して検出します。
- **インタラクティブな編集**:
    - **移動**: ドラッグ＆ドロップで位置調整
    - **リサイズ**: ハンドル操作でサイズ変更
    - **回転**: ハンドル操作で角度調整
    - **追加/削除**: 手動での追加や、誤検知の削除
- **使いやすさとプライバシー**:
    - **ファイル名の継承**: アップロードしたファイル名（例: `photo.png`）を引き継いで保存します（`photo_masked.jpg`）。
    - **軽量な保存**: 画質を保ちつつファイルサイズを抑えるために、最適化されたJPEG形式で出力します。
- **選べるマスク種類**:
    - **4種類の絵文字**: 標準の笑顔(☺️)に加え、にっこり(😊)、爆笑(😂)、青ざめ(😨)を選択可能。
    - **白塗り/黒塗り**: プライバシー保護のためのシンプルな塗りつぶし（⬜/⬛）。
    - **自由なリサイズ**: 白塗り・黒塗りは縦横比を固定せず、自由な長方形に変形できます（絵文字は比率を維持）。
- **進化した背景ぼかし機能**:
    - **高精度な被写体保護**: AIが人物と背景を厳密に区別し、髪の毛や服の端まで綺麗に残して背景だけをぼかします。
    - **可視化アシスト**: 自動ぼかしや手動ぼかしの際、ぼかされる範囲（背景）が**赤色**で表示されるため、仕上がりを直感的に確認できます。
    - **正確な手動モード**: 「囲ってぼかす」機能でも、AIの判定結果を見ながら微調整が可能です。
- **便利な機能**:
    - **クリップボードへコピー**: 画像を保存せずに、ボタン一つでクリップボードにコピーしてSNS等に貼り付けられます。
    - **スマートな操作性**: 選択状態に応じたスムーズな設定変更や、ボタン内での完了通知など、快適なUXを実現。
- **高画質画像の完全対応**:
    - **画質の維持**: リサイズなしで元の高画質な画像をそのまま保存・ダウンロードできます。
    - **正確な位置補正**: 4000px超の高解像度画像でも、AIが検出した位置にピタリとマスクを配置します。

## 無料で公開 (Deployment)

### 無料サービスの選び方

| サービス | 速度 | 起動 | クレカ登録 | おすすめ |
| :--- | :--- | :--- | :--- | :--- |
| **Vercel** | △ 遅め | ◎ 速い | **不要** | **手軽さ重視** (現在の設定) |
| **Cloud Run** | ◎ 爆速 | ◎ 速い | **必要** | **速度重視** (設定が少し大変) |
| **Render** | ◯ 普通 | △ 遅い | **不要** | **バランス** (スリープあり) |

- **Cloud Run**: 毎月200万回のリクエストまで無料枠があります（実質ずっと無料）。ただしアカウント作成にクレカ登録が必要です。
- **Render**: 無料ですが、15分放置するとスリープし、次の起動に1分ほどかかります。

---

### Google Cloud Runへのデプロイ (推奨: 高速・安定)
**Vercelで速度に不満がある場合はこちらがおすすめです。**
（初期設定が必要ですが、一度設定すれば高速に動作します）

1. [Google Cloud Console](https://console.cloud.google.com/) でプロジェクトを作成。
2. `Cloud Run API` と `Artifact Registry API` を有効化。
3. ローカルに [Google Cloud CLI](https://cloud.google.com/sdk/docs/install) をインストール。
4. 以下のコマンドでデプロイ:
   ```bash
   # ログイン
   gcloud auth login

   # デプロイ (初回はリージョン選択などが出ます、 "asia-northeast1" 推奨)
   gcloud run deploy --source .
   ```
   - サービス名: `face-mask` (エンター押下)
   - 未認証の呼び出し: `y` (許可する)

### Vercelへのデプロイ
1. [Vercel](https://vercel.com/) にGitHubアカウントでログイン。
2. "Add New..." > "Project" を選択し、このリポジトリ (`face-mask`) をImport。
3. 設定はすべてデフォルトのままで "Deploy" をクリック。
   - ※ `vercel.json` が含まれているため、Python環境として自動認識されます。

### Renderへのデプロイ (代替案: メアドのみでOK)
**「Vercelより速くしたいけど、クレカ登録はイヤ」という場合はこちら。**

1. Renderで "Web Service" を新規作成し、GitHubリポジトリを連携。
2. Build Command: `pip install -r requirements.txt`
3. Start Command: `gunicorn app:app`
4. Plan: `Free` を選択。


## ローカルでの起動方法 (開発者向け)

1. リポジトリをクローンします。
2. 仮想環境を作成して有効化します:
   ```bash
   python -m venv venv
   source venv/bin/activate
   ```
3. 依存ライブラリをインストールします:
   ```bash
   pip install -r requirements.txt
   ```
4. サーバーを起動します:
   ```bash
   python app.py
   ```
5. ブラウザで [http://localhost:5001](http://localhost:5001) にアクセスします。

## 使い方

1. **画像のアップロード**:
   - ファイルを選択するか、ドラッグ＆ドロップで画像を読み込みます。
   - AIが自動で顔を検出し、デフォルトの絵文字で隠します。

2. **マスクの編集**:
   - **移動・変形**: マスクをドラッグして移動、ハンドル操作で回転・拡大縮小が可能です。
   - **種類の変更**: ☺️ 😊 😂 😨 ⬜ ⬛ のボタンでマスクの種類を変更できます。
   - **追加・削除**: 何もない場所をクリックして新規追加、選択状態で「Deleteキー」または削除ボタンで削除できます。

3. **背景ぼかし**:
   - **自動ぼかし**: ワンクリックで背景をぼかします。赤色で範囲が表示されるので確認も簡単です。
   - **囲ってぼかす**: 手動でぼかしたい範囲をなぞって指定できます。

4. **保存・共有**:
   - **画像を保存**: 編集した画像をダウンロードします。
   - **クリップボードにコピー**: 画像を保存せずに直接コピーし、SNSやチャットに貼り付けられます。

